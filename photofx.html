<!doctype html>
<html>
  <head>
    <title>OpenGL Tutorials</title>
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <canvas id="canvas" width="800px" height="600px"></canvas>
    <input type="file" id="image" />

    <script src="utils.js"></script>
    <script>
      'use strict';

      document.getElementById('image').onchange = changeImage;

      const gl = initGL();

      const triangleData = new Float32Array([
        1.0, 1.0, 0.0,
        -1.0, 1.0, 0.0,
        1.0, -1.0, 0.0,
        -1.0, -1.0, 0.0,
      ]);

      const buffer = gl.createBuffer();

      gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
      gl.bufferData(gl.ARRAY_BUFFER, triangleData.buffer, gl.STATIC_DRAW);

      let sampleTextureId, sampleImage;

      function changeImage(event) {
        const reader = new FileReader();
        reader.onload = function(event) {
          sampleImage = new Image();
          sampleImage.onload = function() {
            console.info('Image loaded...');
            // TODO: Resize to power of 2
            sampleTextureId = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, sampleTextureId);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, sampleImage);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
            gl.generateMipmap(gl.TEXTURE_2D);
            gl.bindTexture(gl.TEXTURE_2D, null);
          }
          sampleImage.src = event.target.result;
        };
        reader.readAsDataURL(event.target.files[0]);
      }

      loadProgram(gl, 'shaders/passthrough.vsh', 'shaders/holgaart.fsh')
        .then((program) => {
          const aPosition = gl.getAttribLocation(program, 'aPosition');
          const uTime = gl.getUniformLocation(program, 'uTime');
          const uSampler = gl.getUniformLocation(program, 'uSampler');
          const uResolution = gl.getUniformLocation(program, 'uResolution');

          let time = 0;

          setRenderFunc((deltaTime) => {
            time += deltaTime;

            gl.useProgram(program);
            gl.enableVertexAttribArray(aPosition);
            gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0);
            gl.uniform1f(uTime, time);
            if (sampleTextureId) {
              gl.bindTexture(gl.TEXTURE_2D, sampleTextureId);
              gl.uniform1i(uSampler, sampleTextureId);
            }
            gl.uniform2fv(uResolution, [800, 600]);
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            gl.disableVertexAttribArray(aPosition);
          });
        });
    </script>
  </body>
</html>
